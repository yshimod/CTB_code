# Data Generation and Estimation Instructions

Synthetic decision data for simulation agents can be generated by following the procedures outlined below, and parameter estimation for each agent can be performed using this data.
The datasets generated during and analyzed during this study are available from the corresponding author upon reasonable request.


## 0. Verified Environment:
- R 4.4.0
- `truncnorm` 1.0.9 (package for R)
- Stata/SE 16.0 for Windows (64-bit x86), Revision 14 Nov 2019
- Python 3.9.13 (distributed with Anaconda3-2022.10)


## 1. Generate Data Without Noise
- Run `generate_zeronoise_data.R` in R.
- Output file: `base_zeronoise.csv`
- Processing time: 1 minute and 40 seconds (based on execution on iMac15,5 (M3), RAM: 24GB)


## 2. Generate Data With Noise
- Ensure the library `truncnorm` is installed in your R environment.
- Run `generate_perturbed_data.R` in R.
- Output file: `base_perturbed.csv`
- Processing time: 1 minute and 10 seconds (based on execution on iMac15,5 (M3), RAM: 24GB)
- Codebook: 
    - `ID`: The simulation agent's ID, consisting of a 7-digit number (without zero padding). 
        - The format is as follows: [beta index][rho index][delta index][noise index][0][0][iteration index].
    - `delta`: Ground-truth value for the discount factor delta.
    - `rho`: Ground-truth value for the curvature parameter rho.
    - `beta`: Ground-truth value for the present bias parameter beta.
    - `sd`: Standard deviation of Gaussian noise added to the data.
    - `time`: Front-end delay, t.
    - `lag`: Length between two periods, k.
    - `price_sooner`: Price of consumption in the sooner period, 1+r.
    - `price_later`: Price of consumption in the later period.
    - `income`: Initial endowment, m.
    - `cons_sooner`: Demand for the agent for the sooner period, c\_{t}.
    - `cons_later`: Demand for the agent for the later period, c\_{t+1}.
    - `noise`: Variation in the value of the demand function g, due to noise.


## 3. Parameter Estimation in Stata
- Use the Do-file: `estimate.do`
    - This Do-file is based on the code from lines 11 to 72 of the file, `112569-V1/Stata/Do/Individual-Analysis-Final.do`, included in the replication data of Andreoni and Sprenger (2012, AER).[*1]
- Output file: `base_estimated.dta`
- Processing time: Approximately 96 DAYS (based on execution on a Windows 10 PC with an Intel i5-7400 processor, RAM: 8GB)
    - It is not practical to wait for 3 months using only a single CPU process. Therefore, the input data (`base_perturbed.csv`) should be split, and parallel processing should be employed using multiple CPU processes (or multiple PCs) to reduce the computation time.
- Codebook:
    - `labnumber`: The simulation agent's ID, consisting of a 7-digit number (without zero padding).
    - `delta`: Ground-truth value for the discount factor delta.
    - `rho`: Ground-truth value for the curvature parameter rho.
    - `beta`: Ground-truth value for the present bias parameter beta.
    - `sd`: Standard deviation of Gaussian noise added to the data.
    - `lnsigma`: Ground-truth value for the curvature parameter ln(sigma).
    - `convergei`: 1 if converged, 0 otherwise.
    - `alphai`: Estimated rho.
    - `betai`: Estimated beta.
    - `deltai`: Estimated delta.
    - `se_alpha`: Standard error of `alphai`.
    - `se_beta`: Standard error of `betai`.
    - `se_delta`: Standard error of `deltai`.
    - `ratei`: Estimated annual discount rate.
    - `lnsigmai`: Estimated curvature parameter ln(sigma).
    - `cparami`: Estimated latent variable theta, where 4 * tanh(theta) = ln(sigma).
    - `se_rate`: Standard error of `ratei`.
    - `se_lnsigma`: Standard error of `lnsigmai`.
    - `se_cparam`: Standard error of `cparami`.
    - `cov_betadelta`: Covariance of `betai` and `deltai`.
    - `cov_cparambeta`: Covariance of `cparami` and `betai`.
    - `cov_cparamdelta`: Covariance of `cparami` and `deltai`.
    - `ic`: Number of iterations.
    - `mss`: Model sum of squares.
    - `mms`: Model mean square.
    - `msr`: Residual mean square.
    - `rmse`: Root mean squared error.
    - `ll`: Log likelihood assuming i.i.d. normal errors.
    - `r2`: Coefficient of determination, R^2.
    - `r2_a`: Adjusted R^2.
    - `dev`: Residual deviance.
    - `rss`: Residual sum of squares.
    - `tss`: Total sum of squares.
    - `cil_delta`: Lower confidence limit of the delta estimate.
    - `ciu_delta`: Upper confidence limit of the delta estimate.
    - `cil_beta`: Lower confidence limit of the beta estimate.
    - `ciu_beta`: Upper confidence limit of the beta estimate.
    - `neqone_delta`: 1 if the null hypothesis that the delta estimate equals 1 is rejected.
    - `neqone_beta`: 1 if the null hypothesis that the beta estimate equals 1 is rejected.


## 4. Generate Figures 1â€“3
- Run the script `plot.py` in the Python environment of Anaconda3-2022.10.


## 5. Some Attempts to Improve Parameter Estimation
- Estimation of the parameter beta alone (M1): `estimate_M1.do`
- Two-stage estimation (M2):
    1. Estimation of parameters other than beta for data with non-zero front-end delay: `estimate_M2_1.do`
    2. Estimation of parameter beta using pre-estimated delta and curvature estimates: `estimate_M2_2.do`
- Estimation with fixed curvature (M3): `estimate_M3.do`
    - Estimation for the case of ground-truth ln(sigma) > 2.5, fixing its value to 2.5: `estimate_M3_capped.do`
- Estimation of parameter beta as the ratio of two discount factors (M4):
    1. Estimation of parameter delta for data with non-zero front-end delay: `estimate_M2_1.do`
    2. Estimation of parameter delta for data with zero front-end delay and computation of the parameter beta: `estimate_M4.do`
- Maximum likelihood estimation with the multinomial logit model: `estimate_mlogit.R` (approximately 18.9 hours)


### Design for CTB Experiments

Replace lines 138 to 145 of `generate_zeronoise_data.R` with the corresponding codes for the respective problem sets below:

- PS1
    ```
    times <- c(rep(0, 21*2), rep(1, 21*2))

    lags <- rep(70, 42*2)

    r_plus_1 <- rep(seq(0.6, 2, length=21*2), 2)
    prices <- matrix(c(r_plus_1, rep(1, 42*2)), 42*2, 2)

    incomes <- rep(20, 42*2)
    ```

- PS2
    ```
    times <- c(rep(0, 21*10), rep(1, 21*10))

    lags <- rep(70, 42*10)

    r_plus_1 <- rep(seq(0.6, 2, length=21*10), 2)
    prices <- matrix(c(r_plus_1, rep(1, 42*10)), 42*10, 2)

    incomes <- rep(20, 42*10)
    ```

- PS3
    ```
    times <- c(rep(0, 21*2), rep(1, 21*2))

    lags <- rep(c(rep(35, 21), rep(70, 21)), 2)

    r_plus_1 <- rep(seq(0.6, 2, length=21), 2*2)
    prices <- matrix(c(r_plus_1, rep(1, 42*2)), 42*2, 2)

    incomes <- rep(20, 42*2)
    ```

- PS4
    ```
    times <- c(rep(0, 21*10), rep(1, 21*10))

    lags <- rep(rep(seq(35, 98, length=10), each = 21), 2)

    r_plus_1 <- rep(seq(0.6, 2, length=21), 2*10)
    prices <- matrix(c(r_plus_1, rep(1, 42*10)), 42*10, 2)

    incomes <- rep(20, 42*10)
    ```

- PS5
    ```
    times <- c(rep(0, 21), rep(1, 21))

    lags <- rep(c(
        round(70 * log(0.75) / log(seq(0.6, 0.95, length = 6))),
        round(70 * log(1.25) / log(seq(1.02, 2, length = 15)))
    ), 2)

    r_plus_1 <- rep(c(rep(0.75, 6), rep(1.25, 15)), 2)
    prices <- matrix(c(r_plus_1, rep(1, 42)), 42, 2)

    incomes <- rep(20, 42)
    ```

- PS6
    ```
    times <- c(rep(0, 21), rep(1, 21))

    lags <- rep(rep(seq(35, 98, length = 7), each = 3), times = 2)

    r_plus_1 <- rep(seq(0.9, 1.5, length=3), 14)
    prices <- matrix(c(r_plus_1, rep(1, 42)), 42, 2)

    incomes <- rep(20, 42)
    ```

- PS7
    ```
    times <- c(rep(0, 21), rep(1, 21))

    lags <- rep(c(rep(35, 7), rep(70, 7), rep(98, 7)), 2)

    r_plus_1 <- rep(seq(0.6, 2, length=7), 6)
    prices <- matrix(c(r_plus_1, rep(1, 42)), 42, 2)

    incomes <- rep(20, 42)
    ```

- PS8
    ```
    times <- c(rep(0, 21), rep(1, 21))

    lags <- rep(c(rep(35, 7), rep(175, 7), rep(350, 7)), 2)

    r_plus_1 <- rep(seq(0.6, 2, length=7), 6)
    prices <- matrix(c(r_plus_1, rep(1, 42)), 42, 2)

    incomes <- rep(20, 42)
    ```

- PS9
    ```
    times <- c(rep(0, 14), rep(1, 14*2))

    lags <- rep(70, 42)

    r_plus_1 <- rep(seq(0.6, 2, length=14), 3)
    prices <- matrix(c(r_plus_1, rep(1, 42)), 42, 2)

    incomes <- rep(20, 42)
    ```

To run the estimation, adjust line 8 of the `estimate.do`, which is `gen ndf = 42`, as necessary.
This line specifies the number of budget constraints included in the problem set.




## References
[*1] Andreoni, J., and Sprenger, C. Replication data for: Estimating Time Preferences from Convex Budgets. Nashville, TN: American Economic Association [publisher], 2012. Ann Arbor, MI: Inter-university Consortium for Political and Social Research [distributor], 2019-10-11. https://doi.org/10.3886/E112569V1
